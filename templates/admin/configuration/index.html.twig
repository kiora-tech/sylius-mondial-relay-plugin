{% extends '@SyliusAdmin/shared/layout/base.html.twig' %}

{% block title %}{{ 'kiora_sylius_mondial_relay.ui.configuration'|trans }} | {{ parent() }}{% endblock %}

{% block body %}
    {% hook 'kiora_sylius_mondial_relay.admin.configuration.index' with { form: form } %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const testBtn = document.getElementById('test-connection-btn');
        const resultSpan = document.getElementById('test-connection-result');

        if (testBtn) {
            testBtn.addEventListener('click', function(e) {
                e.preventDefault();

                const apiKey = document.getElementById('{{ form.api_key.vars.id }}').value;
                const apiSecret = document.getElementById('{{ form.api_secret.vars.id }}').value;
                const brandId = document.getElementById('{{ form.brand_id.vars.id }}').value;
                const sandboxCheckbox = document.getElementById('{{ form.sandbox.vars.id }}');
                const sandbox = sandboxCheckbox ? sandboxCheckbox.checked : false;

                resultSpan.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>{{ "kiora_sylius_mondial_relay.ui.test_connection.testing"|trans }}';
                testBtn.disabled = true;

                fetch('{{ path("kiora_sylius_mondial_relay_admin_configuration_test_connection") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: new URLSearchParams({
                        api_key: apiKey,
                        api_secret: apiSecret,
                        brand_id: brandId,
                        sandbox: sandbox ? '1' : '0'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    testBtn.disabled = false;
                    if (data.success) {
                        resultSpan.innerHTML = '<span class="badge bg-success">' + data.message + '</span>';
                    } else {
                        resultSpan.innerHTML = '<span class="badge bg-danger">' + data.message + '</span>';
                    }
                })
                .catch(error => {
                    testBtn.disabled = false;
                    resultSpan.innerHTML = '<span class="badge bg-danger">{{ "kiora_sylius_mondial_relay.ui.test_connection.error"|trans }}</span>';
                });
            });
        }
    });
    </script>
{% endblock %}
